version: '3'

volumes:
  arl_db:
    external: true

services:
  web:
    image: xinghe0/arl_2_src:v2.62
    container_name: arl_web
    restart: unless-stopped
    depends_on:
      - mongodb
      - rabbitmq
    ports:
      - "80:80"
    volumes:
      - ./arlconfig.yaml:/code/ARL_2/app/arlconfig.yaml
      - ./arl_web.log:/code/ARL_2/arl_web.log
      - ./image:/code/ARL_2/app/tmp_screenshot
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: [ "sh", "-c", "nginx; wait-for-it.sh mongodb:27017; wait-for-it.sh rabbitmq:5672;cd /code/ARL_2; gunicorn -b 0.0.0.0:5018 app.main:arl_app -w 3 --access-logfile arl_web.log" ]
    environment:
      - LANG=en_US.UTF-8
      - TZ=Asia/Shanghai

  worker:
    image: xinghe0/arl_2_src:v2.62
    container_name: arl_worker
    restart: unless-stopped
    depends_on:
      - mongodb
      - rabbitmq
    volumes:
      - ./arlconfig.yaml:/code/ARL_2/app/arlconfig.yaml
      - ./arl_worker.log:/code/ARL_2/arl_worker.log
      - ./image:/code/ARL_2/app/tmp_screenshot
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: [ "sh", "-c", "wait-for-it.sh mongodb:27017; wait-for-it.sh rabbitmq:5672;cd /code/ARL_2; celery -A app.celerytask.celery worker -l info -Q arlgithub -n arlgithub -c 2 -O fair -f arl_worker.log &
         celery -A app.celerytask.celery worker -l info -Q arltask -n arltask -c 10 -O fair -f arl_worker.log" ]

    environment:
      - LANG=en_US.UTF-8
      - TZ=Asia/Shanghai

  scheduler:
    image: xinghe0/arl_2_src:v2.62
    container_name: arl_scheduler
    restart: unless-stopped
    volumes:
      - ./arlconfig.yaml:/code/ARL_2/app/arlconfig.yaml
    depends_on:
      - mongodb
      - rabbitmq
    entrypoint: [ "sh", "-c", "wait-for-it.sh mongodb:27017; wait-for-it.sh rabbitmq:5672;cd /code/ARL_2;python3 -m app.scheduler" ]
    environment:
      - LANG=en_US.UTF-8
      - TZ=Asia/Shanghai

  mongodb:
    image: mongo:4.0.27
    container_name: arl_mongodb
    restart: always
    volumes:
      - arl_db:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro


  rabbitmq:
    image: rabbitmq:3.13.1-management-alpine
    container_name: arl_rabbitmq
    restart: always
    environment:
      - RABBITMQ_DEFAULT_PASS=arlpassword
      - RABBITMQ_DEFAULT_USER=arl
      - RABBITMQ_DEFAULT_VHOST=arlv2host
    logging:
      driver: "json-file"
      options:
        max-size: "1M"
        max-file: "10"
